  name: Build

  on:
    push:
      branches: [ "main", "develop" ]
    pull_request:
      branches: [ "main" ]

  jobs:
    build:
      runs-on: ubuntu-latest
      permissions:
        contents: read

      services:
        postgres:
          image: postgres:16
          env:
            POSTGRES_DB: qualitrace
            POSTGRES_USER: root
            POSTGRES_PASSWORD: P@ssw0rd
          ports:
            - 5432:5432
          options: >-
            --health-cmd pg_isready
            --health-interval 10s
            --health-timeout 5s
            --health-retries 5

        redis:
          image: redis:7
          ports:
            - 6379:6379

      steps:
        - uses: actions/checkout@v4

        - name: Set up JDK 25
          uses: actions/setup-java@v4
          with:
            java-version: '25'
            distribution: 'temurin'
            cache: gradle

        - name: Setup Gradle
          uses: gradle/actions/setup-gradle@v4

        - name: Build backend with Gradle
          run: ./gradlew build
          working-directory: backend
          env:
            SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/qualitrace
            SPRING_DATASOURCE_USERNAME: root
            SPRING_DATASOURCE_PASSWORD: P@ssw0rd
            SPRING_DATA_REDIS_HOST: localhost
            SPRING_DATA_REDIS_PORT: 6379